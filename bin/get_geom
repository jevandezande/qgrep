#!/usr/bin/env python3

# Script that takes an output file and gets the last geometry

import argparse
import importlib
import sys
sys.path.insert(0, '../')

from qgrep.helper import read


parser = argparse.ArgumentParser(description='Get the geometry from an output file.')
parser.add_argument('-i', '--input', help='The file to be read.', type=str,
                    default='output.dat')
parser.add_argument('-o', '--output', help='Where to output the geometry.',
                    type=str, default='geom.xyz')
parser.add_argument('-t', '--type', help='The geometry style', type=str,
                    default='xyz')
parser.add_argument('-u', '--units', help='What units to output the geometry in.',
                    type=str, default='angstrom')
parser.add_argument('-l', '--length', help='Output the geometry at the beginning (making it a true .xyz file)',
                    action='store_true', default=False)

args = parser.parse_args()

lines, program = read(args.input)

xyz_form = '{:<2} {: >15.10f} {: >15.10f} {: >15.10f}\n'
zmat_form = '{:<2} {:>2.0f} {: > 15.10f} {:>2.0f} {: > 15.10f} {:>2.0f} {: > 15.10f}\n'
orca_zmat_form = '{:<2} {:>2.0f} {:>2.0f} {:>2.0f} {: >10.6} {: > 10.6} {: > 10.6}\n'
if program:
    if args.type == 'zmat':
        if program == 'orca':
            form = orca_zmat_form
        else:
            form = zmat_form
    else:
        form = xyz_form
    try:
        mod = importlib.import_module('qgrep.' + program)
        if hasattr(mod, 'get_geom'):
            geom = mod.get_geom(lines, args.type, args.units)
            out = ''
            if args.length:
                out = '{0}\n\n'.format(len(geom))
            for line in geom:
                atom, *coords = line.split()
                out += form.format(atom, *map(float, coords))
            open(args.output, 'w').write(out)
        else:
            print(program + ' does not yet have check_convergence implemented.')
    except ImportError:
        print(program + ' is not yet supported.')
else:
    print('Cannot determine what program made this output file.')

