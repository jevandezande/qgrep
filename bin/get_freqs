#!/usr/bin/env python3

import argparse
from cclib import ccopen
import os, sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from qgrep.atom import numbers_atomic


parser = argparse.ArgumentParser(description='Get the geometry of an output file.')
parser.add_argument('-i', '--input', help='The file to be read.', type=str,
                    default='output.dat')
parser.add_argument('-o', '--output', help='Where to output the geometry.',
                    type=str, default='geom.xyz')

args = parser.parse_args()

data = ccopen(args.input).parse()

disps_array = data.vibdisps
freqs = data.vibfreqs
irs = data.vibirs
geoms = data.atomcoords
atoms = [numbers_atomic[atom] for atom in data.atomnos]

out = ''
header_form = str(data.natom) + "\n{:>5.3f}: {:7.5f}\n"
line_form = "{:2} " + " {:>10.7f}"*6 + "\n"
for disps, freq, ir in zip(disps_array, freqs, irs):
    out += header_form.format(freq, ir)
    for atom, xyz, dxyz in zip(atoms, geoms[-1], disps):
        out += line_form.format(atom, *xyz, *dxyz)
    out += '\n'

with open(args.output, 'w') as f:
    f.write(out)
